<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <title>websocket client</title>
    <script type="text/javascript">

        let currentAssetType = undefined;
        let currentSpriteName = undefined;
        let currentSpriteFrame = 0;
        let currentSpriteFramesCount = 0;

        var start = function () {
            var inc = document.getElementById('incomming');
            var wsImpl = window.WebSocket || window.MozWebSocket;
            var form = document.getElementById('sendForm');
            var input = document.getElementById('sendText');

            inc.innerHTML += "connecting to server ..<br/>";

            // create a new websocket and connect
            window.ws = new wsImpl('ws://localhost:6464/');

            // when data is comming from the server, this metod is called
            ws.onmessage = function (evt) {
                if (typeof(evt.data) === "string") {
                    let message = JSON.parse(evt.data);
                    let command = message["CommandName"];
                    let payload = message["Data"];

                    if (command === "ListPackages") {
                        handleIncomingAssetPackages(payload);
                    }
                    else if (command === "SendingAsset") {
                        currentAssetType = payload["AssetType"];
                    }
                    else if (command === "GetSpriteFramesCount") {
                        currentSpriteFramesCount = payload;
                    }
                    else {
                        handleIncomingMessageDefault(payload);
                    }
                }
                else {
                    switch (currentAssetType) {
                        case "Sprite":
                            handleIncomingSpriteAssetData(evt.data);
                            break;

                        case "Audio":
                            handleIncomingAudioAssetData(evt.data);
                            break;

                        default:
                            break;
                    }
                }
            };

            // when the connection is established, this method is called
            ws.onopen = function () {
                inc.innerHTML += '.. connection open<br/>';
            };

            // when the connection is closed, this method is called
            ws.onclose = function () {
                inc.innerHTML += '.. connection closed<br/>';
            }

			form.addEventListener('submit', function(e){
				e.preventDefault();
				var val = input.value;
				ws.send(val);
				input.value = "";
			});
        };

        function handleIncomingAssetPackages(packages) {
            let assetsByPackage = { "all": [] };
            let palettes = [];

            let select = document.getElementById("selectPackage");
            for (let packageName in packages) {
                let element = document.createElement("option");
                element.textContent = packageName;
                element.value = packageName;
                select.appendChild(element);

                assetsByPackage[packageName] = [];
                for (let index in packages[packageName]) {
                    let assetName = packages[packageName][index];
                    assetsByPackage[packageName].push(assetName);
                    assetsByPackage["all"].push(assetName);

                    if (assetName.endsWith(".pal")) {
                        palettes.push(assetName);
                    }
                };
            };

            window.localStorage.setItem("assetsByPackage", JSON.stringify(assetsByPackage));
            window.localStorage.setItem("palettes", JSON.stringify(palettes));

            populatePalettes();
        };

        function handleIncomingSpriteAssetData(dataBlob) {
            document.getElementById("ItemPreview").src = URL.createObjectURL(dataBlob, "image/png");
            document.getElementById("sendText").value = currentSpriteFrame.toString() + " / " + currentSpriteFramesCount.toString();
        };

        function handleIncomingAudioAssetData(dataBlob) {
            let audioStream = dataBlob.stream();
            readStream(audioStream);
        };

        function handleIncomingMessageDefault(message) {
            console.log(message);
            var inc = document.getElementById('incomming');
            inc.innerHTML += message + '<br/>';
        };

        function populatePalettes() {
            var select = document.getElementById("selectPalette");
            select.innerHTML = null;

            let palettes = JSON.parse(localStorage.getItem("palettes"));
            if (palettes !== null) {
                palettes.forEach(paletteName => {
                    var element = document.createElement("option");
                    element.textContent = paletteName;
                    element.value = paletteName;
                    select.appendChild(element);
                });
            }
        };

        function populateAssets(selectedPackage) {
            var select = document.getElementById("selectAsset");
            select.innerHTML = null;

            var assets = JSON.parse(localStorage.getItem("assetsByPackage"))[selectedPackage];
            if (assets !== null)
            {
                assets.forEach(assetName => {
                    var element = document.createElement("option");
                    element.textContent = assetName;
                    element.value = assetName;
                    select.appendChild(element);
                });
            }

            requestSetPalette("unittem.pal");

            if (select.options.length > 0) {
                currentSpriteName = select.options[0].value;
                requestSpriteFramesCount(currentSpriteName)
                requestAsset(currentSpriteName);
            }
        };

        function nextFrame() {
            currentSpriteFrame++;
            requestAsset(currentSpriteName);
        };

        function requestAsset(selectedAsset) {
            document.getElementById("ItemPreview").src = null;
            let message = {
                CommandName: "LoadAsset",
                AssetName: selectedAsset,
                FrameNumber: currentSpriteFrame.toString()
            };

            ws.send(JSON.stringify(message));
        };

        function requestSpriteFramesCount(selectedAsset) {
            let message = {
                CommandName: "GetSpriteFramesCount",
                AssetName: selectedAsset
            };

            ws.send(JSON.stringify(message));
        };

        function requestSetPalette(selectedPalette) {
            // let paletteName = "temperat.pal";
            // let paletteName = "PALETTE.BIN";
            let paletteName = "unittem.pal";
            let message = {
                CommandName: "SetPalette",
                PaletteName: paletteName
            };

            ws.send(JSON.stringify(message));
        };

        window.onload = start;

        function updateCurrentAsset(selectedAsset) {
            currentSpriteFrame = 0;
            currentSpriteName = selectedAsset;
            requestSpriteFramesCount(currentSpriteName);
            requestAsset(currentSpriteName);
        };

        function readStream(readableStream) {
            const reader = readableStream.getReader();
            let charsReceived = 0;

            // read() returns a promise that resolves
            // when a value has been received
            reader.read().then(
                function processText({ done, value }) {
                    // Result objects contain two properties:
                    // done  - true if the stream has already given you all its data.
                    // value - some data. Always undefined when done is true.
                    if (done) {
                        // Do stuff here?
                        return;
                    }

                    charsReceived += value.length;
                    const chunk = value;
                    startAudioStream(chunk);

                    // Read some more, and call this function again
                    return reader.read().then(processText);
                }
            );
        }

        function startAudioStream(rawBytes, sampleRate, latency) {
            let arrayBuffer = new ArrayBuffer(rawBytes.length);
            let floatArray = new Float32Array(arrayBuffer);
            let byteArray = new Uint8Array(arrayBuffer);

            rawBytes.forEach(function (b, i) {
                byteArray[i] = b;
            });

            var AudioContext = window.AudioContext || window.webkitAudioContext;
            var context = new AudioContext();
            var nextTime = 0;

            // function update(byteArray) {
                // buffer = context.createBuffer(1, byteArray.byteLength / 4, sampleRate);
                let buffer = context.createBuffer(2, floatArray.length / 2, 22050);

                buffer.copyToChannel(floatArray.filter((element, index) => { return index % 2 === 0; }), 0);
                buffer.copyToChannel(floatArray.filter((element, index) => { return index % 2 !== 0; }), 1);

                var source = context.createBufferSource();
                source.buffer = buffer;

                //if (nextTime == 0)
                //    nextTime = context.currentTime + latency;

                source.connect(context.destination);
                source.start();
                //nextTime += buffer.duration;
            // };

            // audioClient = new BinaryClient(websocketAddress);
            // audioClient.on('stream', function(stream, meta) {
            //     stream.on('data', function(data) {
            //         update(new Float32Array(data));
            //     });
            // });
        }
    </script>
</head>
<body>
	<form id="sendForm">
		<input id="sendText" placeholder="Text to send" />
	</form>
    <select name="selectPackage" id="selectPackage" onchange="populateAssets(this.value)">
        <option value="none"></option>
        <option value="all">All packages</option>
    </select>
    <select name="selectAsset" id="selectAsset" onchange="updateCurrentAsset(this.value)"></select>
    <select name="selectPalette" id="selectPalette" onchange="setPalette(this.value)"></select>
    <br/>
    <button name="nextFrameButton" id="nextFrameButton" onclick="nextFrame()">Next frame</button>
    <pre id="incomming"></pre>
    <img id="ItemPreview" src="">
</body>
</html>
